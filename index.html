<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Task Wallet</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(-45deg, #001a33, #003366, #0077ff, #001a33);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
      color: white;
      text-align: center;
      overflow-x: hidden;
      position: relative;
      font-size: 14px;
      touch-action: manipulation; /* Prevent double-tap zoom */
      -webkit-user-select: none; /* Disable text selection */
      user-select: none;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .ticker {
      background: rgba(255, 0, 0, 0.7);
      padding: 5px;
      font-size: 12px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .ticker marquee {
      color: white;
    }

    .wallet {
      padding: 10px;
      max-width: 100%;
      margin: 0 auto;
      padding-top: 30px;
    }

    .header {
      position: sticky;
      top: 0;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      z-index: 100;
      border-radius: 0 0 12px 12px;
    }

    .balance {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 8px;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 5px #00ccff, 0 0 10px #00ccff; }
      to { text-shadow: 0 0 10px #0077ff, 0 0 15px #0077ff; }
    }

    .btn {
      display: inline-block;
      margin: 5px;
      padding: 12px;
      background: linear-gradient(45deg, #0077ff, #00ccff);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      min-width: 80px;
      text-align: center;
      line-height: 20px;
    }

    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 10px rgba(0, 204, 255, 0.5);
    }

    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-icon::before {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 5px;
      vertical-align: middle;
      background-size: contain;
      background-repeat: no-repeat;
    }

    .btn-claim::before { background-image: url('https://i.postimg.cc/8C9sG2q8/claim.png'); }
    .btn-withdraw::before { background-image: url('https://i.postimg.cc/7L9G2XzW/withdraw.png'); }
    .btn-buy::before { background-image: url('https://i.postimg.cc/4xZ7YqX8/buy.png'); }
    .btn-dashboard::before { background-image: url('https://i.postimg.cc/SK7C4YqV/dashboard.png'); }
    .btn-spin::before { background-image: url('https://i.postimg.cc/0yD2qW9T/spin.png'); }
    .btn-reset::before { background-image: url('https://i.postimg.cc/9F2qW9T/reset.png'); }
    .btn-feedback::before { background-image: url('https://i.postimg.cc/9F2qW9T/feedback.png'); }

    hr {
      border: 1px solid rgba(0, 204, 255, 0.3);
      margin: 10px 0;
    }

    .task-section {
      margin: 20px 0;
      opacity: 0;
      transform: translateY(10px);
      animation: slideIn 0.5s ease forwards;
      animation-delay: calc(0.2s * var(--i));
    }

    .task-section.collapsed .task-list {
      display: none;
    }

    .task-section h3 {
      cursor: pointer;
      font-size: 18px;
      margin: 10px 0;
    }

    .task-section h3::after {
      content: 'â–¼';
      margin-left: 5px;
    }

    .task-section.collapsed h3::after {
      content: 'â–¶';
    }

    @keyframes slideIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .task {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 119, 255, 0.2);
      margin: 5px;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .task:hover {
      transform: scale(1.02);
      background: rgba(0, 204, 255, 0.3);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    .task.completed {
      background: rgba(0, 128, 0, 0.2);
      opacity: 0.7;
    }

    .task-info {
      text-align: left;
      font-size: 14px;
      flex: 1;
    }

    .task button {
      background: #0077ff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 12px;
    }

    .task button:hover {
      background: #00ccff;
    }

    .task button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background: rgba(0, 50, 80, 0.95);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 320px;
      color: white;
      text-align: center;
      animation: popupFade 0.3s ease;
    }

    @keyframes popupFade {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .timer {
      font-size: 18px;
      margin: 10px 0;
      font-weight: bold;
      color: #00ccff;
    }

    .back-to-top {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: #0077ff;
      color: white;
      padding: 8px 12px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
    }

    .back-to-top:hover {
      background: #00ccff;
    }

    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #00ccff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 5px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .form-group {
      margin: 10px 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }

    .form-group input:disabled, .form-group select:disabled {
      background: rgba(255, 255, 255, 0.05);
      color: #ccc;
    }

    .qr-code img {
      max-width: 150px;
      margin: 10px 0;
      border-radius: 6px;
    }

    .error-message {
      color: #ff4d4d;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .success-message {
      color: #4dff4d;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .task-list {
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #00ccff #001a33;
    }

    .task-list::-webkit-scrollbar {
      width: 6px;
    }

    .task-list::-webkit-scrollbar-track {
      background: #001a33;
    }

    .task-list::-webkit-scrollbar-thumb {
      background: #00ccff;
      border-radius: 3px;
    }

    .progress-circle {
      width: 40px;
      height: 40px;
      margin: 10px auto;
      position: relative;
    }

    .progress-circle svg {
      transform: rotate(-90deg);
    }

    .progress-circle circle {
      fill: none;
      stroke: #00ccff;
      stroke-width: 4;
      stroke-dasharray: 113;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 0.3s ease;
    }

    .progress-circle text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4d4d;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 10px;
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }

    .profile-section {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 8px;
    }

    .profile-section img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }

    .filter-bar input, .filter-bar select {
      padding: 6px;
      border-radius: 6px;
      font-size: 12px;
      flex: 1;
      min-width: 100px;
    }

    .leaderboard, .dashboard, .achievements, .activity-log {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 12px;
    }

    .canvas-container {
      margin: 10px 0;
    }

    .spin-wheel-container {
      position: relative;
    }

    .spin-wheel-container::after {
      content: 'â–¼';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      color: #ff4d4d;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
  </div>
  <div class="ticker">
    <marquee>All actions are at your own risk. Proceed with caution.</marquee>
  </div>
  <div class="particles" id="particles"></div>
  <div class="wallet">
    <div class="header">
      <div class="profile-section">
        <img src="https://i.postimg.cc/4NqX0y1R/default-avatar.png" alt="Avatar">
        <div>
          <span id="profileName">Guest User ðŸ˜Ž</span><br>
          <small>Level: <span id="userLevel">1</span> | Points: <span id="userPoints">0</span></small>
        </div>
      </div>
      <div class="balance">Balance: <span id="currency">â‚¹</span><span id="balance">0.00</span></div>
      <div>
        <span class="btn btn-claim" onclick="dailyClaim()" aria-label="Claim Daily Bonus">Claim</span>
        <span class="btn btn-withdraw" onclick="openPopup('withdraw')" aria-label="Withdraw Funds">Withdraw</span>
        <span class="btn btn-buy" onclick="openPopup('buy')" aria-label="Buy Credits">Buy</span>
        <span class="btn btn-dashboard" onclick="openPopup('dashboard')" aria-label="View Dashboard">Dashboard</span>
        <span class="btn btn-spin" onclick="openPopup('spin')" aria-label="Spin Wheel">Spin</span>
        <span class="btn btn-feedback" onclick="openPopup('feedback')" aria-label="Submit Feedback">Feedback</span>
        <span class="btn btn-reset" onclick="resetAll()" aria-label="Reset Data">Reset</span>
      </div>
      <div class="filter-bar">
        <input type="text" id="taskSearch" placeholder="Search Tasks..." oninput="filterTasks()">
        <select id="taskFilter" onchange="filterTasks()">
          <option value="all">All</option>
          <option value="completed">Completed</option>
          <option value="pending">Pending</option>
        </select>
        <select id="taskSort" onchange="sortTasks()">
          <option value="default">Default</option>
          <option value="reward">Reward</option>
          <option value="name">Name</option>
        </select>
      </div>
    </div>

    <hr>

    <div class="task-section" style="--i: 1">
      <h3 onclick="toggleSection(this)">Daily Tasks <span class="notification-badge" id="dailyBadge">0</span></h3>
      <div id="dailyTasks" class="task-list"></div>
    </div>

    <div class="task-section" style="--i: 2">
      <h3 onclick="toggleSection(this)">Medium Tasks <span class="notification-badge" id="mediumBadge">0</span></h3>
      <div id="mediumTasks" class="task-list"></div>
    </div>

    <div class="task-section" style="--i: 3">
      <h3 onclick="toggleSection(this)">High Tasks <span class="notification-badge" id="highBadge">0</span></h3>
      <div id="highTasks" class="task-list"></div>
    </div>

    <div class="task-section" style="--i: 4">
      <h3 onclick="toggleSection(this)">Special Collaboration <span class="notification-badge" id="specialBadge">0</span></h3>
      <div id="specialTasks" class="task-list"></div>
    </div>

    <div class="leaderboard">
      <h3>Leaderboard</h3>
      <div id="leaderboard"></div>
    </div>

    <div class="achievements">
      <h3>Achievements</h3>
      <div id="achievements"></div>
    </div>

    <div class="activity-log">
      <h3>Activity Log</h3>
      <div id="activityLog"></div>
      <button class="btn" onclick="exportLog()">Export as CSV</button>
    </div>

    <div class="canvas-container">
      <canvas id="earningsGraph" width="300" height="150"></canvas>
    </div>
  </div>

  <div class="popup" id="claimPopup">
    <div class="popup-content">
      <h3>Daily Claim Used</h3>
      <p>Next claim in:</p>
      <div class="timer" id="claimTimer">24:00:00</div>
      <button onclick="closePopup('claim')">Close</button>
    </div>
  </div>

  <div class="popup" id="buyPopup">
    <div class="popup-content">
      <h3>Buy Credits</h3>
      <p>Scan QR to add funds</p>
      <div class="qr-code">
        <img src="https://i.postimg.cc/WFcpfHkj/qr-code.png" alt="QR Code">
        <p>Minimum: <span id="buyMin">â‚¹200</span></p>
      </div>
      <div class="form-group">
        <label for="buyAmount">Amount</label>
        <input type="number" id="buyAmount" min="200" placeholder="Minimum â‚¹200">
        <div class="error-message" id="buyError"></div>
      </div>
      <div class="form-group">
        <label for="referralCode">Referral Code</label>
        <input type="text" id="referralCode" placeholder="Enter Referral Code">
      </div>
      <button onclick="confirmBuy()">Confirm</button>
      <button onclick="closePopup('buy')">Close</button>
    </div>
  </div>

  <div class="popup" id="withdrawPopup">
    <div class="popup-content">
      <h3>Withdraw Funds</h3>
      <div id="withdrawForm">
        <div class="form-group">
          <label for="upiId">UPI ID</label>
          <input type="text" id="upiId" placeholder="Enter UPI ID" onblur="autoSaveWithdraw()">
          <div class="error-message" id="upiError"></div>
        </div>
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" id="name" placeholder="Enter Name" onblur="autoSaveWithdraw()">
          <div class="error-message" id="nameError"></div>
        </div>
        <div class="form-group withdraw-amount">
          <label for="withdrawAmount">Amount</label>
          <input type="number" id="withdrawAmount" min="100" placeholder="Minimum â‚¹100">
          <div class="error-message" id="withdrawError"></div>
          <div class="success-message" id="withdrawSuccess"></div>
        </div>
        <button id="editBtn" onclick="enableEdit()">Edit</button>
        <button id="saveBtn" onclick="saveWithdrawDetails()" style="display: none;">Save</button>
        <button id="withdrawBtn" onclick="confirmWithdraw()">Withdraw</button>
        <button onclick="openPopup('withdrawHistory')">History</button>
        <button onclick="closePopup('withdraw')">Close</button>
      </div>
    </div>
  </div>

  <div class="popup" id="dashboardPopup">
    <div class="popup-content">
      <h3>Dashboard</h3>
      <div class="dashboard">
        <p>Tasks Completed: <span id="totalTasks">0</span></p>
        <p>Earnings: <span id="currencyDash">â‚¹</span><span id="totalEarnings">0.00</span></p>
        <p>Streak: <span id="streakCount">0</span> days</p>
        <p>Level: <span id="dashLevel">1</span></p>
      </div>
      <button onclick="closePopup('dashboard')">Close</button>
    </div>
  </div>

  <div class="popup" id="spinPopup">
    <div class="popup-content">
      <h3>Spin the Wheel</h3>
      <p>Spins Left Today: <span id="spinsLeft">5</span></p>
      <div class="spin-wheel-container">
        <canvas id="spinWheel" width="150" height="150"></canvas>
      </div>
      <button onclick="spinWheel()">Spin Now</button>
      <button onclick="closePopup('spin')">Close</button>
    </div>
  </div>

  <div class="popup" id="withdrawHistoryPopup">
    <div class="popup-content">
      <h3>Withdraw History</h3>
      <div id="withdrawHistory"></div>
      <button onclick="closePopup('withdrawHistory')">Close</button>
    </div>
  </div>

  <div class="popup" id="feedbackPopup">
    <div class="popup-content">
      <h3>Feedback</h3>
      <div class="form-group">
        <label for="feedbackText">Your Feedback</label>
        <textarea id="feedbackText" rows="3" placeholder="Enter feedback"></textarea>
      </div>
      <button onclick="submitFeedback()">Submit</button>
      <button onclick="closePopup('feedback')">Close</button>
    </div>
  </div>

  <div class="popup" id="sessionTimeoutPopup">
    <div class="popup-content">
      <h3>Session Timeout</h3>
      <p>Inactive for too long. Refresh to continue.</p>
      <button onclick="location.reload()">Refresh</button>
    </div>
  </div>

  <div class="popup" id="proofPopup">
    <div class="popup-content">
      <h3>Upload Proof</h3>
      <div class="form-group">
        <label for="proofFile">Select Image from Gallery</label>
        <input type="file" id="proofFile" accept="image/*">
        <div class="error-message" id="proofError"></div>
      </div>
      <button onclick="submitProof()">Submit</button>
      <button onclick="closePopup('proof')">Cancel</button>
    </div>
  </div>

  <div class="back-to-top" onclick="scrollToTop()">â†‘</div>

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    // Initialize Particles.js (optimized for mobile)
    particlesJS("particles", {
      particles: {
        number: { value: 30, density: { enable: true, value_area: 600 } },
        color: { value: "#00ccff" },
        shape: { type: "circle" },
        opacity: { value: 0.2, random: true },
        size: { value: 2, random: true },
        line_linked: { enable: false },
        move: { enable: true, speed: 0.5, direction: "none", random: true }
      },
      interactivity: { enable: false }
    });

    // Show Loading Screen
    document.getElementById("loadingScreen").style.display = "flex";
    setTimeout(() => {
      document.getElementById("loadingScreen").style.display = "none";
    }, 800);

    // Initialize Data
    let balance = parseFloat(localStorage.getItem("balance")) || 0;
    let points = parseInt(localStorage.getItem("points")) || 0;
    let level = Math.floor(points / 100) + 1;
    let completedTasks = JSON.parse(localStorage.getItem("completedTasks")) || {};
    let withdrawDetails = JSON.parse(localStorage.getItem("withdrawDetails")) || {};
    let withdrawHistory = JSON.parse(localStorage.getItem("withdrawHistory")) || [];
    let activityLog = JSON.parse(localStorage.getItem("activityLog")) || [];
    let achievements = JSON.parse(localStorage.getItem("achievements")) || [];
    let streak = parseInt(localStorage.getItem("streak")) || 0;
    let lastLogin = localStorage.getItem("lastLogin") || "";
    let profile = JSON.parse(localStorage.getItem("profile")) || { name: "Guest User ðŸ˜Ž" };
    let currency = "INR"; // Fixed to INR for simplicity
    let taskCompletionsToday = parseInt(localStorage.getItem("taskCompletionsToday")) || 0;
    let lastTaskDate = localStorage.getItem("lastTaskDate") || "";
    let feedbackList = JSON.parse(localStorage.getItem("feedbackList")) || [];
    let spinsToday = parseInt(localStorage.getItem("spinsToday")) || 0;
    let lastSpinDate = localStorage.getItem("lastSpinDate") || "";
    let currentTaskId = null;

    // Update UI
    document.getElementById("balance").innerText = balance.toFixed(2);
    document.getElementById("profileName").innerText = profile.name;
    document.getElementById("userLevel").innerText = level;
    document.getElementById("userPoints").innerText = points;
    if (withdrawDetails.upiId && withdrawDetails.name) {
      document.getElementById("upiId").value = withdrawDetails.upiId;
      document.getElementById("name").value = withdrawDetails.name;
    }
    updateSpinsLeft();

    // Task Lists
    const dailyTasks = [
      { text: "Check Daily News", link: "https://news.google.com", reward: 0.2 },
      { text: "Watch Tutorial Video", link: "https://youtube.com", reward: 0.3 },
      { text: "Visit Tech Blog", link: "https://techcrunch.com", reward: 0.2 }
    ];

    const mediumTasks = [
      { text: "Follow Google on Twitter", link: "https://twitter.com/Google", reward: 0.5 },
      { text: "Subscribe to YouTube Channel", link: "https://youtube.com/@Google", reward: 0.5 },
      { text: "Visit Instagram Page", link: "https://instagram.com/google", reward: 0.5 },
      { text: "Check Wikipedia AI Page", link: "https://en.wikipedia.org/wiki/Artificial_intelligence", reward: 0.5 },
      { text: "Open Gmail", link: "https://mail.google.com", reward: 0.5 },
      { text: "Visit Google Maps", link: "https://maps.google.com", reward: 0.5 },
      { text: "Read Tech News", link: "https://techcrunch.com", reward: 0.5 },
      { text: "Open Translate", link: "https://translate.google.com", reward: 0.5 },
      { text: "Visit Google Photos", link: "https://photos.google.com", reward: 0.5 },
      { text: "Search Cricket Score", link: "https://www.google.com/search?q=cricket+score", reward: 0.5 }
    ];

    const highTasks = [
      { text: "Upload Video to YouTube", link: "https://youtube.com", reward: 5, requiresProof: true },
      { text: "Join Telegram", link: "https://telegram.org", reward: 7 },
      { text: "Tweet Trending Hashtag", link: "https://twitter.com/explore", reward: 8 },
      { text: "Post Story on Instagram", link: "https://instagram.com", reward: 6 },
      { text: "Share on Facebook", link: "https://facebook.com", reward: 9 }
    ];

    const specialRewards = [30, 40, 50, 70, 80];
    const specialTasks = [
      { text: "Google Ads Campaign", link: "https://ads.google.com", requiresProof: true },
      { text: "Collaborate with Influencer", link: "https://twitter.com", requiresProof: true },
      { text: "Launch Twitter Space", link: "https://twitter.com", requiresProof: true },
      { text: "Host YouTube Live", link: "https://youtube.com", requiresProof: true },
      { text: "Write Whitepaper", link: "https://docs.google.com", requiresProof: true }
    ];

    // Achievements
    const achievementList = [
      { id: "tasks10", name: "Task Novice", description: "Complete 10 tasks", points: 50, condition: () => Object.keys(completedTasks).length >= 10 },
      { id: "earn100", name: "Money Maker", description: "Earn â‚¹100", points: 100, condition: () => balance >= 100 },
      { id: "streak5", name: "Streak Star", description: "5-day streak", points: 150, condition: () => streak >= 5 }
    ];

    // Render Tasks
    function renderTasks(list, id, rewards = null) {
      let html = "";
      let completedCount = 0;
      list.forEach((task, i) => {
        let reward = task.reward || rewards[i % rewards.length];
        let taskId = `${id}-${i}`;
        let isCompleted = completedTasks[taskId];
        if (isCompleted) completedCount++;
        html += `
          <div class="task ${isCompleted ? 'completed' : ''}">
            <div class="task-info">
              ${task.text}<br>
              <small>Earn â‚¹${reward.toFixed(2)}</small>
              <div class="tooltip">${task.description || "Complete to earn rewards."}</div>
              ${task.timeLimit ? `<small>Time Left: <span id="timer-${taskId}"></span></small>` : ''}
            </div>
            ${isCompleted ? 
              '<button disabled>Done</button>' : 
              `<button onclick="completeTask('${taskId}', ${reward}, this, '${task.link || ''}', ${task.requiresProof || false})">
                ${task.requiresProof ? 'Proof' : 'Do'}
              </button>`}
          </div>`;
      });
      document.getElementById(id).innerHTML = html;
      const progress = (completedCount / list.length) * 100;
      const circle = `<svg><circle cx="20" cy="20" r="18" stroke-dashoffset="${113 - (progress * 1.13)}"></circle></svg><text x="20" y="20">${Math.round(progress)}%</text>`;
      const progressHtml = `<div class="progress-circle">${circle}</div><small>${completedCount}/${list.length} Done</small>`;
      document.getElementById(id).nextElementSibling.innerHTML = progressHtml;
      document.getElementById(`${id.replace('Tasks', '')}Badge`).innerText = list.length - completedCount;
      list.forEach((task, i) => {
        if (task.timeLimit && !completedTasks[`${id}-${i}`]) {
          startTaskTimer(`${id}-${i}`, task.timeLimit);
        }
      });
    }

    // Task Timer
    function startTaskTimer(taskId, timeLimit) {
      let timeLeft = timeLimit * 1000;
      let timerId = setInterval(() => {
        if (timeLeft <= 0 || completedTasks[taskId]) {
          clearInterval(timerId);
          document.getElementById(`timer-${taskId}`).innerText = "Expired";
          return;
        }
        let m = Math.floor((timeLeft % 3600000) / 60000);
        let s = Math.floor((timeLeft % 60000) / 1000);
        document.getElementById(`timer-${taskId}`).innerText = `${m}:${String(s).padStart(2, '0')}`;
        timeLeft -= 1000;
      }, 1000);
    }

    // Render All Tasks
    renderTasks(dailyTasks, "dailyTasks");
    renderTasks(mediumTasks, "mediumTasks");
    renderTasks(highTasks, "highTasks");
    renderTasks(specialTasks, "specialTasks", specialRewards);

    // Complete Task
    function completeTask(taskId, amount, btn, link, requiresProof) {
      if (completedTasks[taskId]) return;
      if (taskCompletionsToday >= 10) {
        alert("Daily task limit (10) reached. Try tomorrow.");
        return;
      }
      if (requiresProof) {
        currentTaskId = taskId;
        openPopup('proof');
        return;
      }
      if (!confirm("Completed this task?")) return;
      btn.disabled = true;
      btn.innerText = "Processing";
      btn.innerHTML += '<span class="spinner"></span>';
      setTimeout(() => {
        if (link) window.open(link, "_blank");
        balance += amount * (streak >= 5 ? 1.5 : 1);
        points += Math.floor(amount * 10);
        level = Math.floor(points / 100) + 1;
        taskCompletionsToday++;
        localStorage.setItem("taskCompletionsToday", taskCompletionsToday);
        localStorage.setItem("lastTaskDate", new Date().toDateString());
        updateBalance();
        completedTasks[taskId] = true;
        localStorage.setItem("completedTasks", JSON.stringify(completedTasks));
        localStorage.setItem("points", points);
        document.getElementById("userLevel").innerText = level;
        document.getElementById("userPoints").innerText = points;
        btn.innerText = "Done";
        btn.parentElement.classList.add("completed");
        confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 } });
        navigator.vibrate?.(200);
        logActivity(`Completed task ${taskId} for â‚¹${amount}`);
        checkAchievements();
        updateLeaderboard();
        updateDashboard();
        renderTasks(dailyTasks, "dailyTasks");
        renderTasks(mediumTasks, "mediumTasks");
        renderTasks(highTasks, "highTasks");
        renderTasks(specialTasks, "specialTasks", specialRewards);
      }, 1500);
    }

    // Submit Proof
    function submitProof() {
      const fileInput = document.getElementById("proofFile");
      const errorEl = document.getElementById("proofError");
      errorEl.style.display = 'none';
      if (!fileInput.files[0] || !fileInput.files[0].type.startsWith("image/")) {
        errorEl.textContent = "Please select an image file.";
        errorEl.style.display = 'block';
        return;
      }
      logActivity(`Uploaded proof for task ${currentTaskId}`);
      alert("Proof uploaded successfully! (Simulated)");
      closePopup('proof');
      const btn = document.querySelector(`button[onclick*="completeTask('${currentTaskId}'"]`);
      completeTask(currentTaskId, parseFloat(btn.getAttribute('onclick').match(/, (\d+\.?\d*),/)[1]), btn, '', false);
    }

    // Update Balance
    function updateBalance() {
      localStorage.setItem("balance", balance.toFixed(2));
      document.getElementById("balance").innerText = balance.toFixed(2);
      updateEarningsGraph();
    }

    // Daily Claim
    function dailyClaim() {
      let lastClaim = parseInt(localStorage.getItem("lastClaim")) || 0;
      let now = Date.now();
      if (lastClaim && now - lastClaim < 86400000) {
        document.getElementById("claimPopup").style.display = "flex";
        startClaimTimer(86400000 - (now - lastClaim));
        return;
      }
      balance += 5 * (streak >= 5 ? 1.5 : 1);
      points += 50;
      streak++;
      localStorage.setItem("streak", streak);
      updateBalance();
      localStorage.setItem("lastClaim", now);
      logActivity("Claimed daily bonus â‚¹5");
      checkAchievements();
      alert(`Claimed â‚¹${5 * (streak >= 5 ? 1.5 : 1)}! Streak: ${streak} days`);
      navigator.vibrate?.(200);
    }

    // Claim Timer
    function startClaimTimer(remaining) {
      let timerId = setInterval(() => {
        if (remaining <= 0) {
          clearInterval(timerId);
          document.getElementById("claimPopup").style.display = "none";
          return;
        }
        let h = Math.floor(remaining / 3600000);
        let m = Math.floor((remaining % 3600000) / 60000);
        let s = Math.floor((remaining % 60000) / 1000);
        document.getElementById("claimTimer").innerText =
          `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        remaining -= 1000;
      }, 1000);
    }

    // Buy Feature
    function confirmBuy() {
      let amount = parseFloat(document.getElementById("buyAmount").value);
      let referralCode = document.getElementById("referralCode").value.trim();
      let errorEl = document.getElementById("buyError");
      errorEl.style.display = 'none';
      if (isNaN(amount) || amount < 200) {
        errorEl.textContent = "Minimum â‚¹200 required.";
        errorEl.style.display = 'block';
        return;
      }
      if (referralCode === "TASKWALLET2025") {
        amount *= 1.1;
        spinsToday++;
        localStorage.setItem("spinsToday", spinsToday);
        updateSpinsLeft();
        logActivity(`Used referral code for 10% bonus and extra spin`);
      }
      balance += amount;
      points += Math.floor(amount * 5);
      updateBalance();
      alert(`Added â‚¹${amount.toFixed(2)}!`);
      closePopup('buy');
      navigator.vibrate?.(200);
    }

    // Withdraw Feature
    function confirmWithdraw() {
      let amount = parseFloat(document.getElementById("withdrawAmount").value);
      let errorEl = document.getElementById("withdrawError");
      let successEl = document.getElementById("withdrawSuccess");
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      if (!withdrawDetails.upiId || !withdrawDetails.name) {
        errorEl.textContent = "Save UPI ID and Name first.";
        errorEl.style.display = 'block';
        return;
      }
      if (isNaN(amount) || amount < 100) {
        errorEl.textContent = "Minimum â‚¹100 required.";
        errorEl.style.display = 'block';
        return;
      }
      if (amount > balance) {
        errorEl.textContent = "Insufficient balance.";
        errorEl.style.display = 'block';
        return;
      }
      if (withdrawHistory.filter(h => new Date(h.date).toDateString() === new Date().toDateString()).length >= 2) {
        errorEl.textContent = "Daily withdrawal limit (2) reached.";
        errorEl.style.display = 'block';
        return;
      }
      balance -= amount;
      withdrawHistory.push({ amount, date: new Date().toISOString(), upiId: withdrawDetails.upiId });
      localStorage.setItem("withdrawHistory", JSON.stringify(withdrawHistory));
      updateBalance();
      logActivity(`Withdrew â‚¹${amount.toFixed(2)} to ${withdrawDetails.upiId}`);
      successEl.textContent = `â‚¹${amount.toFixed(2)} withdrawn (Simulated).`;
      successEl.style.display = 'block';
      updateWithdrawHistory();
      setTimeout(() => closePopup('withdraw'), 2000);
      navigator.vibrate?.(200);
    }

    // Auto-Save Withdraw Details
    function autoSaveWithdraw() {
      let upiId = sanitizeInput(document.getElementById("upiId").value.trim());
      let name = sanitizeInput(document.getElementById("name").value.trim());
      let upiError = document.getElementById("upiError");
      let nameError = document.getElementById("nameError");
      upiError.style.display = 'none';
      nameError.style.display = 'none';
      if (!upiId.includes('@')) {
        upiError.textContent = "Invalid UPI ID (e.g., user@upi).";
        upiError.style.display = 'block';
        return;
      }
      if (!name) {
        nameError.textContent = "Name is required.";
        nameError.style.display = 'block';
        return;
      }
      withdrawDetails = { upiId, name };
      localStorage.setItem("withdrawDetails", JSON.stringify(withdrawDetails));
      document.getElementById("upiId").disabled = true;
      document.getElementById("name").disabled = true;
      document.getElementById("saveBtn").style.display = "none";
      document.getElementById("editBtn").style.display = "inline-block";
      logActivity("Auto-saved withdrawal details");
      alert("Details saved!");
    }

    // Enable Edit
    function enableEdit() {
      document.getElementById("upiId").disabled = false;
      document.getElementById("name").disabled = false;
      document.getElementById("saveBtn").style.display = "inline-block";
      document.getElementById("editBtn").style.display = "none";
    }

    // Save Withdraw Details
    function saveWithdrawDetails() {
      autoSaveWithdraw();
    }

    // Withdraw History
    function updateWithdrawHistory() {
      let html = withdrawHistory.map(h => `<p>${new Date(h.date).toLocaleString()}: â‚¹${h.amount.toFixed(2)} to ${h.upiId}</p>`).join('');
      document.getElementById("withdrawHistory").innerHTML = html || "<p>No withdrawals.</p>";
    }
    updateWithdrawHistory();

    // Activity Log
    function logActivity(message) {
      activityLog.push({ message, date: new Date().toISOString() });
      localStorage.setItem("activityLog", JSON.stringify(activityLog));
      updateActivityLog();
    }

    function updateActivityLog() {
      let html = activityLog.slice(-5).map(log => `<p>${new Date(log.date).toLocaleString()}: ${log.message}</p>`).join('');
      document.getElementById("activityLog").innerHTML = html || "<p>No activity.</p>";
    }
    updateActivityLog();

    // Export Log
    function exportLog() {
      const csv = activityLog.map(log => `${new Date(log.date).toLocaleString()},"${log.message}"`).join('\n');
      const blob = new Blob([`Date,Activity\n${csv}`], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'activity_log.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Achievements
    function checkAchievements() {
      achievementList.forEach(ach => {
        if (!achievements.includes(ach.id) && ach.condition()) {
          achievements.push(ach.id);
          points += ach.points;
          localStorage.setItem("achievements", JSON.stringify(achievements));
          localStorage.setItem("points", points);
          alert(`Achievement: ${ach.name} (+${ach.points} points)`);
          navigator.vibrate?.(200);
        }
      });
      updateAchievements();
    }

    function updateAchievements() {
      let html = achievementList.map(ach => `<p>${ach.name}: ${ach.description} ${achievements.includes(ach.id) ? 'âœ…' : 'ðŸ”’'}</p>`).join('');
      document.getElementById("achievements").innerHTML = html || "<p>No achievements.</p>";
    }
    updateAchievements();

    // Leaderboard
    let leaderboard = JSON.parse(localStorage.getItem("leaderboard")) || [
      { name: "User1", points: 500 },
      { name: profile.name, points: points },
      { name: "User3", points: 300 }
    ];

    function updateLeaderboard() {
      leaderboard = leaderboard.filter(u => u.name !== profile.name);
      leaderboard.push({ name: profile.name, points });
      leaderboard.sort((a, b) => b.points - a.points);
      localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
      let html = leaderboard.slice(0, 5).map((user, i) => `<p>${i + 1}. ${user.name}: ${user.points} points</p>`).join('');
      document.getElementById("leaderboard").innerHTML = html || "<p>No leaderboard.</p>";
    }
    updateLeaderboard();

    // Dashboard
    function updateDashboard() {
      document.getElementById("totalTasks").innerText = Object.keys(completedTasks).length;
      document.getElementById("totalEarnings").innerText = balance.toFixed(2);
      document.getElementById("streakCount").innerText = streak;
      document.getElementById("dashLevel").innerText = level;
    }
    updateDashboard();

    // Earnings Graph
    let earningsData = JSON.parse(localStorage.getItem("earningsData")) || [];
    const ctx = document.getElementById("earningsGraph").getContext("2d");
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: earningsData.map((_, i) => `Day ${i + 1}`),
        datasets: [{
          label: 'Earnings',
          data: earningsData,
          borderColor: '#00ccff',
          fill: false
        }]
      },
      options: { scales: { y: { beginAtZero: true } }, responsive: true }
    });

    function updateEarningsGraph() {
      earningsData.push(balance);
      if (earningsData.length > 15) earningsData.shift();
      localStorage.setItem("earningsData", JSON.stringify(earningsData));
      chart.data.labels = earningsData.map((_, i) => `Day ${i + 1}`);
      chart.data.datasets[0].data = earningsData;
      chart.update();
    }
    updateEarningsGraph();

    // Spin Wheel
    const spinWheelCanvas = document.getElementById("spinWheel").getContext("2d");
    const wheelRewards = [1, 2, 5, 10, 0, 3, 7, 0];
    let wheelAngle = 0;
    let spinning = false;

    function drawWheel() {
      spinWheelCanvas.clearRect(0, 0, 150, 150);
      spinWheelCanvas.beginPath();
      for (let i = 0; i < 8; i++) {
        spinWheelCanvas.fillStyle = i % 2 ? "#0077ff" : "#00ccff";
        spinWheelCanvas.beginPath();
        spinWheelCanvas.moveTo(75, 75);
        spinWheelCanvas.arc(75, 75, 75, (i * Math.PI / 4) + wheelAngle, ((i + 1) * Math.PI / 4) + wheelAngle);
        spinWheelCanvas.fill();
        spinWheelCanvas.fillStyle = "white";
        spinWheelCanvas.font = "12px Arial";
        spinWheelCanvas.save();
        spinWheelCanvas.translate(75, 75);
        spinWheelCanvas.rotate((i * Math.PI / 4) + (Math.PI / 8) + wheelAngle);
        spinWheelCanvas.fillText(`â‚¹${wheelRewards[i]}`, 40, 0);
        spinWheelCanvas.restore();
      }
    }
    drawWheel();

    function updateSpinsLeft() {
      if (lastSpinDate !== new Date().toDateString()) {
        spinsToday = 5;
        localStorage.setItem("spinsToday", spinsToday);
        localStorage.setItem("lastSpinDate", new Date().toDateString());
      }
      document.getElementById("spinsLeft").innerText = spinsToday;
    }

    function spinWheel() {
      if (spinning) return;
      if (spinsToday <= 0) {
        alert("No spins left today!");
        return;
      }
      spinning = true;
      let spin = Math.random() * 360 + 720;
      let interval = setInterval(() => {
        wheelAngle += 0.1;
        drawWheel();
        spin -= 0.1;
        if (spin <= 0) {
          clearInterval(interval);
          spinning = false;
          let rewardIndex = Math.floor(((wheelAngle % (2 * Math.PI)) / (Math.PI / 4))) % 8;
          let reward = wheelRewards[rewardIndex];
          spinsToday--;
          localStorage.setItem("spinsToday", spinsToday);
          updateSpinsLeft();
          if (reward > 0) {
            balance += reward;
            updateBalance();
            logActivity(`Won â‚¹${reward} from spin wheel`);
            alert(`You won â‚¹${reward}!`);
            navigator.vibrate?.(200);
          } else {
            alert("Try again!");
          }
          localStorage.setItem("lastSpin", Date.now());
        }
      }, 16);
    }

    // Task Filtering
    function filterTasks() {
      const search = document.getElementById("taskSearch").value.toLowerCase();
      const filter = document.getElementById("taskFilter").value;
      const allTasks = { dailyTasks, mediumTasks, highTasks, specialTasks };
      Object.keys(allTasks).forEach(id => {
        const tasks = allTasks[id];
        const container = document.getElementById(id);
        let html = "";
        let completedCount = 0;
        tasks.forEach((task, i) => {
          let taskId = `${id}-${i}`;
          let isCompleted = completedTasks[taskId];
          if (isCompleted) completedCount++;
          if (
            (filter === "all" || (filter === "completed" && isCompleted) || (filter === "pending" && !isCompleted)) &&
            task.text.toLowerCase().includes(search)
          ) {
            let reward = task.reward || specialRewards[i % specialRewards.length];
            html += `
              <div class="task ${isCompleted ? 'completed' : ''}">
                <div class="task-info">
                  ${task.text}<br>
                  <small>Earn â‚¹${reward.toFixed(2)}</small>
                  <div class="tooltip">${task.description || "Complete to earn rewards."}</div>
                </div>
                ${isCompleted ? 
                  '<button disabled>Done</button>' : 
                  `<button onclick="completeTask('${taskId}', ${reward}, this, '${task.link || ''}', ${task.requiresProof || false})">
                    ${task.requiresProof ? 'Proof' : 'Do'}
                  </button>`}
              </div>`;
          }
        });
        container.innerHTML = html;
        const progress = (completedCount / tasks.length) * 100;
        const circle = `<svg><circle cx="20" cy="20" r="18" stroke-dashoffset="${113 - (progress * 1.13)}"></circle></svg><text x="20" y="20">${Math.round(progress)}%</text>`;
        container.nextElementSibling.innerHTML = `<div class="progress-circle">${circle}</div><small>${completedCount}/${tasks.length} Done</small>`;
        document.getElementById(`${id.replace('Tasks', '')}Badge`).innerText = tasks.length - completedCount;
      });
    }

    // Task Sorting
    function sortTasks() {
      const sortBy = document.getElementById("taskSort").value;
      const allTasks = { dailyTasks, mediumTasks, highTasks, specialTasks };
      Object.keys(allTasks).forEach(id => {
        allTasks[id].sort((a, b) => {
          if (sortBy === "reward") return (b.reward || specialRewards[0]) - (a.reward || specialRewards[0]);
          if (sortBy === "name") return a.text.localeCompare(b.text);
          return 0;
        });
      });
      renderTasks(dailyTasks, "dailyTasks");
      renderTasks(mediumTasks, "mediumTasks");
      renderTasks(highTasks, "highTasks");
      renderTasks(specialTasks, "specialTasks", specialRewards);
      filterTasks();
    }

    // Collapsible Sections
    function toggleSection(element) {
      element.parentElement.classList.toggle("collapsed");
      navigator.vibrate?.(50);
    }

    // Popup Control
    function openPopup(type) {
      document.getElementById(type + "Popup").style.display = "flex";
      navigator.vibrate?.(50);
    }

    function closePopup(type) {
      document.getElementById(type + "Popup").style.display = "none";
      if (type === 'withdraw') {
        document.getElementById("upiId").disabled = true;
        document.getElementById("name").disabled = true;
        document.getElementById("saveBtn").style.display = "none";
        document.getElementById("editBtn").style.display = "inline-block";
        document.getElementById("withdrawError").style.display = 'none';
        document.getElementById("withdrawSuccess").style.display = 'none';
      } else if (type === 'buy') {
        document.getElementById("buyError").style.display = 'none';
      } else if (type === 'proof') {
        document.getElementById("proofError").style.display = 'none';
        document.getElementById("proofFile").value = "";
      }
    }

    // Session Timeout
    let timeout;
    function resetTimeout() {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        document.getElementById("sessionTimeoutPopup").style.display = "flex";
      }, 15 * 60 * 1000); // 15 minutes
    }
    document.addEventListener("touchstart", resetTimeout);
    resetTimeout();

    // Input Sanitization
    function sanitizeInput(input) {
      const div = document.createElement("div");
      div.textContent = input;
      return div.innerHTML;
    }

    // Daily Login Bonus
    function checkDailyLogin() {
      let now = new Date().toDateString();
      if (lastLogin !== now) {
        balance += 1;
        updateBalance();
        logActivity("Claimed daily login bonus â‚¹1");
        localStorage.setItem("lastLogin", now);
        alert("Daily Login Bonus: â‚¹1");
        navigator.vibrate?.(200);
      }
    }
    checkDailyLogin();

    // Feedback Form
    function submitFeedback() {
      let feedback = sanitizeInput(document.getElementById("feedbackText").value);
      if (!feedback) {
        alert("Please enter feedback.");
        return;
      }
      feedbackList.push({ feedback, date: new Date().toISOString() });
      localStorage.setItem("feedbackList", JSON.stringify(feedbackList));
      logActivity("Submitted feedback");
      alert("Feedback submitted!");
      closePopup('feedback');
      navigator.vibrate?.(200);
    }

    // Scroll to Top
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: "smooth" });
      navigator.vibrate?.(50);
    }

    // Show/Hide Back to Top
    window.addEventListener("scroll", () => {
      document.querySelector(".back-to-top").style.display = window.scrollY > 200 ? "block" : "none";
    });

    // Reset All
    function resetAll() {
      if (confirm("Reset all data?")) {
        localStorage.clear();
        location.reload();
      }
    }
  </script>
</body>
</html>
