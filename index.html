<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save Notes</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background-color: white;
            border-bottom: 1px solid #eee;
            z-index: 1002;
            transition: opacity 0.3s ease;
        }
        .header.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .menu-icon, .settings-icon {
            width: 45px;
            height: 45px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .menu-icon:active, .settings-icon:active {
            transform: scale(0.95);
        }
        .app-name-bar {
            background-color: white;
            text-align: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
            z-index: 1002;
            transition: opacity 0.3s ease;
        }
        .app-name-bar.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .app-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .search-bar {
            padding: 5px;
            background-color: white;
            border-bottom: 1px solid #eee;
            z-index: 1002;
            transition: opacity 0.3s ease;
        }
        .search-bar.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .main-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
        }
        .left-sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background-color: white;
            border-right: 1px solid #ddd;
            transition: left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1001;
            padding: 20px;
            box-sizing: border-box;
        }
        .left-sidebar.open {
            left: 0;
        }
        .right-sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background-color: white;
            border-left: 1px solid #ddd;
            transition: right 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1001;
            padding: 20px;
            box-sizing: border-box;
        }
        .right-sidebar.open {
            right: 0;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .overlay.open {
            display: block;
        }
        .note-file {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            min-height: 180px;
            aspect-ratio: 1;
            draggable: true;
            position: relative;
        }
        .note-file:hover {
            background-color: #f9f9f9;
        }
        .note-file:active {
            transform: scale(0.98);
        }
        .note-file.pinned {
            border-left: 4px solid #007bff;
        }
        .note-file.locked {
            opacity: 0.7;
            border-left: 4px solid #ffc107;
        }
        .note-title {
            font-size: 16px;
            flex: 1;
            margin-bottom: 5px;
        }
        .note-preview {
            font-size: 14px;
            color: #888;
            word-break: break-word;
            line-height: 1.3;
            flex: 1;
        }
        .note-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: auto;
        }
        .edit-icon, .notification-icon, .delete-btn, .pin-icon, .reminder-icon, .lock-icon, .mic-btn {
            width: 25px;
            height: 25px;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .edit-icon:active, .notification-icon:active, .delete-btn:active, .pin-icon:active, .reminder-icon:active, .lock-icon:active, .mic-btn:active {
            transform: scale(0.9);
        }
        .delete-btn {
            font-size: 20px;
            color: #ff4444;
            background: none;
            border: none;
            padding: 0;
        }
        .new-tab-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 65px;
            height: 65px;
            background-color: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s ease;
            z-index: 1003;
        }
        .new-tab-btn:active {
            transform: scale(0.95);
        }
        .new-tab-icon {
            width: 45px;
            height: 45px;
        }
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #eee;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1002;
        }
        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .nav-icon:active {
            transform: scale(0.95);
        }
        .nav-icon img {
            width: 35px;
            height: 35px;
        }
        .nav-label {
            font-size: 10px;
            margin-top: 2px;
        }
        /* Popup styles */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1003;
        }
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        .trash-content {
            text-align: left;
        }
        .editor-content {
            text-align: left;
        }
        .editor-title {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .editor-text {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            resize: vertical;
        }
        .editor-reminder {
            margin: 10px 0;
        }
        .editor-reminder input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .formatting-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .formatting-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
        }
        .checklist-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
        }
        .deleted-note {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            min-height: 60px;
        }
        .deleted-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }
        .alert-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }
        .popup-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .confirm-btn {
            background-color: #ff4444;
            color: white;
        }
        .cancel-btn {
            background-color: #ccc;
            color: black;
        }
        .share-icons {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .share-icon {
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 0 5px;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .share-icon:active {
            transform: scale(0.95);
        }
        /* Reminder Popup Styles */
        #reminderPopup .popup-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #reminderPopup .popup-content h3 {
            margin-bottom: 20px;
        }
        #reminderPopup .popup-content label {
            display: block;
            margin: 15px 0;
            text-align: left;
        }
        #reminderPopup .popup-content input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            box-sizing: border-box;
        }
        /* Password Popup Styles */
        #passwordPopup .popup-content {
            text-align: center;
            max-width: 300px;
        }
        #passwordPopup .popup-content h3 {
            margin-bottom: 10px;
        }
        #passwordPopup .popup-content p {
            margin-bottom: 15px;
            font-weight: bold;
        }
        #passwordPopup .popup-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #passwordPopup .forget-link {
            font-size: 12px;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 10px;
        }
        /* Onboarding guide placeholder */
        .onboarding {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .guide-step {
            position: absolute;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            max-width: 200px;
        }
        .skip-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ccc;
            color: black;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .settings-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        .settings-item:hover {
            background-color: #f9f9f9;
        }
        .settings-item:active {
            transform: scale(0.98);
        }
        .settings-item img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        .no-notes {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-top: 50px;
        }
        .no-deleted {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Overlay for sidebars -->
    <div class="overlay" id="overlay" onclick="closeSidebars()"></div>

    <!-- Left Sidebar for Menu (Deleted Notes) -->
    <div class="left-sidebar" id="leftSidebar">
        <h3>Trash / Recycle Bin</h3>
        <div id="trashContent">
            <div class="no-deleted">No deleted notes.</div>
        </div>
        <div class="popup-buttons">
            <button class="btn cancel-btn" onclick="closeLeftSidebar()">Close</button>
        </div>
    </div>

    <!-- Right Sidebar for Settings -->
    <div class="right-sidebar" id="rightSidebar">
        <h3>Settings</h3>
        <div class="settings-item" onclick="handleSettingsItem('about'); closeRightSidebar();">
            <img src="https://i.postimg.cc/W1z2b5M9/1758011685776.png" alt="About">
            <span>About</span>
        </div>
        <div class="settings-item" onclick="handleSettingsItem('clear'); closeRightSidebar();">
            <img src="https://i.postimg.cc/T1N4kJpw/1758011671773.png" alt="Clear All Data">
            <span>Clear All Data</span>
        </div>
        <div class="settings-item" onclick="toggleDragAndDrop(); closeRightSidebar();">
            <img src="https://i.postimg.cc/kXLXxpyd/1758047844505.png" alt="Drag & Drop">
            <span>Drag & Drop</span>
        </div>
        <div class="settings-item" onclick="toggleOfflineMode(); closeRightSidebar();">
            <img src="https://i.postimg.cc/GpL0YF6C/1758047829493.png" alt="Offline Mode">
            <span>Offline Mode</span>
        </div>
        <div class="settings-item" onclick="toggleChecklist(); closeRightSidebar();">
            <img src="https://i.postimg.cc/nL0y1stQ/images-12.png" alt="Checklist">
            <span>Checklist</span>
        </div>
        <div class="settings-item" onclick="toggleTextFormatting(); closeRightSidebar();">
            <img src="https://i.postimg.cc/W1z2b5M9/1758011685776.png" alt="Text Formatting">
            <span>Text Formatting</span>
        </div>
    </div>

    <!-- Header -->
    <div class="header" id="header">
        <img src="https://i.postimg.cc/MTXktVNT/1758009527072.png" alt="Menu" class="menu-icon" id="menuIcon" onclick="toggleLeftSidebar()">
        <div> </div> <!-- Spacer -->
    </div>

    <!-- App Name Bar -->
    <div class="app-name-bar" id="appNameBar">
        <div class="app-name">Save Notes</div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar" id="searchBar">
        <input type="text" class="search-input" placeholder="Search notes..." id="searchInput">
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="no-notes">No notes yet. Create a new one!</div>
    </div>

    <!-- Editor Popup -->
    <div id="editorPopup" class="popup">
        <div class="popup-content editor-content">
            <input type="text" id="editorTitle" class="editor-title" placeholder="Note Title">
            <div class="formatting-toolbar" id="formattingToolbar" style="display: none;">
                <button class="formatting-btn" onclick="formatText('bold')">B</button>
                <button class="formatting-btn" onclick="formatText('italic')">I</button>
                <button class="formatting-btn" onclick="formatText('underline')">U</button>
                <button class="formatting-btn" onclick="formatText('strikeThrough')">S</button>
                <button class="formatting-btn" onclick="formatText('insertUnorderedList')">UL</button>
                <button class="formatting-btn" onclick="formatText('insertOrderedList')">OL</button>
                <button class="formatting-btn" onclick="formatText('formatBlock', 'h1')">H1</button>
                <button class="formatting-btn" onclick="formatText('formatBlock', 'h2')">H2</button>
                <button class="formatting-btn" onclick="formatText('formatBlock', 'h3')">H3</button>
                <button class="formatting-btn" onclick="formatText('insertHTML', '<code>_<span contenteditable=true></span>_</code>')">Code</button>
                <button class="checklist-btn" onclick="insertChecklist()" id="checklistBtn" style="display: none;">Checklist</button>
            </div>
            <div id="editorText" contenteditable="true" class="editor-text" placeholder="Write your note here..."></div>
            <div class="editor-reminder">
                <label>Date: <input type="date" id="reminderDate"></label>
                <label>Time: <input type="time" id="reminderTime"></label>
            </div>
            <div class="popup-buttons">
                <button class="btn" onclick="saveNote()">Save</button>
                <button class="btn cancel-btn" onclick="closeEditor()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reminder Popup -->
    <div id="reminderPopup" class="popup">
        <div class="popup-content">
            <h3>Set Reminder for <span id="reminderNoteTitle"></span></h3>
            <label>Date: <input type="date" id="popupReminderDate"></label>
            <label>Time: <input type="time" id="popupReminderTime"></label>
            <div class="popup-buttons">
                <button class="btn" onclick="saveReminder()">Save</button>
                <button class="btn cancel-btn" onclick="closeReminderPopup()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Password Popup -->
    <div id="passwordPopup" class="popup">
        <div class="popup-content">
            <h3 id="passwordNoteTitle"></h3>
            <p>Set Password</p>
            <input type="password" id="passwordInput" placeholder="Enter password">
            <div class="popup-buttons">
                <button class="btn" onclick="savePassword()">Save</button>
                <button class="btn cancel-btn" onclick="closePasswordPopup()">Cancel</button>
            </div>
            <a class="forget-link" onclick="forgetPassword()">Forget Password</a>
        </div>
    </div>

    <!-- New Tab Button -->
    <div class="new-tab-btn" onclick="createNewNote()">
        <img src="https://i.postimg.cc/wxRxpRTJ/1758009430835.png" alt="New Tab" class="new-tab-icon">
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-icon" onclick="goHome()">
            <img src="https://i.postimg.cc/ZKQLy3FH/1758009490013.png" alt="Home">
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-icon" onclick="openInvite()">
            <img src="https://i.postimg.cc/nzmy6pVb/1758009504498.png" alt="Invite Friends">
            <div class="nav-label">Invite</div>
        </div>
        <div class="nav-icon" onclick="toggleRightSidebar()">
            <img src="https://i.postimg.cc/YjBqJdB8/1758009478805.png" alt="Settings">
            <div class="nav-label">Settings</div>
        </div>
    </div>

    <!-- Invite Popup -->
    <div id="invitePopup" class="popup">
        <div class="popup-content">
            <h3>You can invite your friends using link</h3>
            <p>and in the future you will get your personal referral code in the Invite section.</p>
            <p>Once available you will be able to share your code and earn â‚¹ rewards directly into your wallet for every successful referral.</p>
            <p>Start inviting now and get ready to earn soon.</p>
            <p>https://jokefitabs.vercel.app/</p>
            <button class="btn" id="copyBtn">Copy Link</button>
            <div class="share-icons">
                <img src="https://i.postimg.cc/Gm4Zftw2/1758012881988.png" alt="Facebook" class="share-icon">
                <img src="https://i.postimg.cc/br2y8T4G/1758012910289.png" alt="WhatsApp" class="share-icon">
                <img src="https://i.postimg.cc/LXg56216/1758012926671.png" alt="X" class="share-icon">
                <img src="https://i.postimg.cc/rsNdR41F/share-icon-on-transparent-background-free-png.png" alt="Share" class="share-icon">
                <img src="https://i.postimg.cc/8C8hVK3v/1758012946979.png" alt="Telegram" class="share-icon">
            </div>
        </div>
    </div>

    <!-- About Popup -->
    <div id="aboutPopup" class="popup">
        <div class="popup-content">
            <h3>About JokeFi Notes</h3>
            <p>JokeFi Notes is the best app designed for everyone who wants to save their personal files, stories, important data, or any kind of notes securely and easily without any delay.</p>
            <p>Unlike other apps that sell your data for profit, JokeFi Notes ensures your privacy is fully protected and your information stays safe forever.</p>
            <p>Whether itâ€™s a personal diary, important documents, creative stories, or simple daily notes â€“ you can save everything instantly in just a few taps.</p>
            <p>Our advanced system keeps your data secure and private at all times, giving you full control.</p>
            <p>Say goodbye to fear of data misuse and hello to a reliable solution where your files are yours alone.</p>
            <p>JokeFi Notes is made for those who value privacy, security, and speed the perfect choice for anyone who wants their notes safe forever without worrying about hidden fees or data leaks.</p>
            <p>Experience the future of note-saving apps today with JokeFi Notes safe simple and always yours.</p>
            <button class="btn" onclick="closeAbout()">Close</button>
        </div>
    </div>

    <!-- Clear All Data Alert Popup -->
    <div id="clearDataPopup" class="popup">
        <div class="popup-content">
            <img src="https://i.postimg.cc/xC8fqtDj/1758012015965.png" alt="Alert" class="alert-icon">
            <p>If you confirm now all your saved notes files will be permanently deleted from the system.</p>
            <p>This action cannot be undone and you will lose all your data forever.</p>
            <p>Please make sure you have backed up any important information before proceeding.</p>
            <div class="popup-buttons">
                <button class="btn confirm-btn" id="confirmClear">Confirm</button>
                <button class="btn cancel-btn" id="cancelClear">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Guide Placeholder -->
    <div id="onboarding" class="onboarding">
        <button class="skip-btn">Skip</button>
        <!-- Guide steps with lines/arrows would need JS/CSS for positioning -->
        <div class="guide-step" style="top: 10px; left: 10px;">
            <p>Menu: Access settings and more</p>
            <div style="width: 50px; height: 2px; background: red; transform: rotate(45deg); margin-top: 5px;"></div>
        </div>
        <!-- Add more steps for other elements -->
    </div>

    <script>
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let deletedNotes = JSON.parse(localStorage.getItem('deletedNotes')) || [];
        let currentEditingId = null;
        let notificationIntervals = {}; // To store intervals for each note
        let reminderTimeouts = {}; // To store timeouts for reminders
        let currentReminderNoteId = null;
        let currentPasswordNoteId = null;
        let draggedNoteId = null;
        let dragAndDropEnabled = false;
        let offlineModeEnabled = false;
        let checklistEnabled = false;
        let textFormattingEnabled = false;
        const url = 'https://jokefitabs.vercel.app/';
        const longText = `I use JokeFi Notes to securely save my personal data, important files, and private stories. 

It feels extremely safe because my information stays fully protected and private Unlike other apps, JokeFi Notes never sells your data and keeps everything encrypted, giving me peace of mind.

Itâ€™s the perfect app to store important notes fast and securely, knowing my data is safe and always accessible only to me.

${url}`;
        const shortText = `Loving JokeFi Notes for secure, private note saving! No data selling, full encryption. Perfect for personal files & stories. ${url}`;

        const notificationOnIcon = 'https://i.postimg.cc/xT7dmGx6/1758009449096.png';
        const notificationOffIcon = 'https://i.postimg.cc/XYFz838T/1758009466327.png';
        const pinIcon = 'https://i.postimg.cc/kXLXxpyd/1758047844505.png';
        const reminderIcon = 'https://i.postimg.cc/GpL0YF6C/1758047829493.png';
        const lockIcon = 'https://i.postimg.cc/nL0y1stQ/images-12.png';

        // Offline mode - register service worker if possible
        if ('serviceWorker' in navigator && offlineModeEnabled) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa('self.addEventListener("fetch", e => e.respondWith(fetch(e.request)));'));
        }

        // Functions to hide/show top bars
        function hideTopBars() {
            document.getElementById('header').classList.add('hidden');
            document.getElementById('appNameBar').classList.add('hidden');
            document.getElementById('searchBar').classList.add('hidden');
        }

        function showTopBars() {
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('appNameBar').classList.remove('hidden');
            document.getElementById('searchBar').classList.remove('hidden');
        }

        // Notification setup
        if ('Notification' in window) {
            Notification.requestPermission();
        }

        function showNotification(title, body) {
            if (Notification.permission === 'granted') {
                new Notification(title, { body });
            }
        }

        function startNoteNotifications(id) {
            const interval = setInterval(() => {
                const note = notes.find(n => n.id === id);
                if (note && note.notification) {
                    showNotification('Note Reminder', 'Your data is safe, there is nothing to worry about. We keep your data more safe and secure than our own.');
                } else {
                    clearInterval(interval);
                }
            }, 5 * 60 * 1000); // 5 minutes
            notificationIntervals[id] = interval;
        }

        function stopNoteNotifications(id) {
            if (notificationIntervals[id]) {
                clearInterval(notificationIntervals[id]);
                delete notificationIntervals[id];
            }
        }

        function setReminder(id, datetime) {
            clearReminder(id);
            const timeout = setTimeout(() => {
                const note = notes.find(n => n.id === id);
                if (note) {
                    showNotification('Reminder', `Reminder for: ${note.title}`);
                }
                delete reminderTimeouts[id];
            }, new Date(datetime) - Date.now());
            reminderTimeouts[id] = timeout;
        }

        function clearReminder(id) {
            if (reminderTimeouts[id]) {
                clearTimeout(reminderTimeouts[id]);
                delete reminderTimeouts[id];
            }
        }

        function renderNotes(filter = '') {
            const mainContent = document.getElementById('mainContent');
            const searchTerm = filter.toLowerCase();
            let filteredNotes = notes.filter(note => 
                note.title.toLowerCase().includes(searchTerm) || 
                (note.content && note.content.toLowerCase().includes(searchTerm))
            );

            // Sort pinned notes to top
            filteredNotes.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

            if (filteredNotes.length === 0) {
                mainContent.innerHTML = '<div class="no-notes">No notes yet. Create a new one!</div>';
                return;
            }

            mainContent.innerHTML = filteredNotes.map(note => `
                <div class="note-file ${note.pinned ? 'pinned' : ''} ${note.password ? 'locked' : ''}" data-id="${note.id}" ${dragAndDropEnabled ? 'draggable="true"' : ''}>
                    <div style="flex: 1;">
                        <span class="note-title">${note.title} ${note.pinned ? 'ðŸ“Œ' : ''} ${note.password ? 'ðŸ”’' : ''}</span>
                        <div class="note-preview">${note.content ? note.content.substring(0, 100) + (note.content.length > 100 ? '...' : '') : ''}</div>
                    </div>
                    <div class="note-actions">
                        <img src="${pinIcon}" class="pin-icon" onclick="togglePin(event, '${note.id}')" alt="Pin">
                        <img src="${note.notification ? notificationOnIcon : notificationOffIcon}" class="notification-icon" onclick="toggleNotification(event, '${note.id}')" alt="${note.notification ? 'On' : 'Off'}">
                        <img src="${reminderIcon}" class="reminder-icon" onclick="setNoteReminder(event, '${note.id}')" alt="Reminder">
                        <img src="${lockIcon}" class="lock-icon" onclick="toggleLock(event, '${note.id}')" alt="Lock">
                        <button class="delete-btn" onclick="deleteNote(event, '${note.id}')">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTrash() {
            const trashContent = document.getElementById('trashContent');
            if (deletedNotes.length === 0) {
                trashContent.innerHTML = '<div class="no-deleted">No deleted notes.</div>';
                return;
            }
            trashContent.innerHTML = deletedNotes.map(note => `
                <div class="deleted-note">
                    <div style="flex: 1;">
                        <span class="note-title">${note.title}</span>
                        <p class="note-preview">${note.content ? note.content.substring(0, 100) + (note.content.length > 100 ? '...' : '') : ''}</p>
                    </div>
                    <div class="deleted-actions">
                        <button class="btn" onclick="restoreNote('${note.id}')">Restore</button>
                        <button class="btn confirm-btn" onclick="permanentDelete('${note.id}')">Delete Forever</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleNotification(event, id) {
            event.stopPropagation();
            const note = notes.find(n => n.id === id);
            if (note) {
                note.notification = !note.notification;
                if (note.notification) {
                    startNoteNotifications(id);
                } else {
                    stopNoteNotifications(id);
                }
                saveNotes();
                renderNotes(document.getElementById('searchInput').value);
            }
        }

        function togglePin(event, id) {
            event.stopPropagation();
            const note = notes.find(n => n.id === id);
            if (note) {
                note.pinned = !note.pinned;
                saveNotes();
                renderNotes(document.getElementById('searchInput').value);
            }
        }

        function setNoteReminder(event, id) {
            event.stopPropagation();
            const note = notes.find(n => n.id === id);
            if (note) {
                currentReminderNoteId = id;
                document.getElementById('reminderNoteTitle').textContent = note.title;
                const [date, time] = note.reminderTime ? note.reminderTime.split('T') : ['', ''];
                document.getElementById('popupReminderDate').value = date;
                document.getElementById('popupReminderTime').value = time;
                hideTopBars();
                document.getElementById('overlay').classList.add('open');
                document.getElementById('reminderPopup').style.display = 'flex';
            }
        }

        function saveReminder() {
            const date = document.getElementById('popupReminderDate').value;
            const time = document.getElementById('popupReminderTime').value;
            if (date && time && currentReminderNoteId) {
                const datetime = date + 'T' + time;
                const note = notes.find(n => n.id === currentReminderNoteId);
                if (note) {
                    note.reminderTime = datetime;
                    clearReminder(currentReminderNoteId);
                    setReminder(currentReminderNoteId, datetime);
                    saveNotes();
                    renderNotes(document.getElementById('searchInput').value);
                }
            }
            closeReminderPopup();
        }

        function closeReminderPopup() {
            document.getElementById('reminderPopup').style.display = 'none';
            document.getElementById('overlay').classList.remove('open');
            showTopBars();
            currentReminderNoteId = null;
        }

        function toggleLock(event, id) {
            event.stopPropagation();
            const note = notes.find(n => n.id === id);
            if (note) {
                currentPasswordNoteId = id;
                document.getElementById('passwordNoteTitle').textContent = note.title;
                document.getElementById('passwordInput').value = '';
                if (note.password) {
                    document.querySelector('#passwordPopup .popup-content p').textContent = 'Enter Password to Unlock';
                } else {
                    document.querySelector('#passwordPopup .popup-content p').textContent = 'Set Password';
                }
                hideTopBars();
                document.getElementById('overlay').classList.add('open');
                document.getElementById('passwordPopup').style.display = 'flex';
            }
        }

        function savePassword() {
            const pass = document.getElementById('passwordInput').value;
            if (currentPasswordNoteId) {
                const note = notes.find(n => n.id === currentPasswordNoteId);
                if (note) {
                    if (note.password) {
                        if (pass === note.password) {
                            note.password = null;
                        } else {
                            alert('Incorrect password');
                            return;
                        }
                    } else {
                        note.password = pass;
                    }
                    saveNotes();
                    renderNotes(document.getElementById('searchInput').value);
                }
            }
            closePasswordPopup();
        }

        function closePasswordPopup() {
            document.getElementById('passwordPopup').style.display = 'none';
            document.getElementById('overlay').classList.remove('open');
            showTopBars();
            currentPasswordNoteId = null;
        }

        function forgetPassword() {
            if (confirm('Are you sure you want to forget the password? This will unlock the note.')) {
                const note = notes.find(n => n.id === currentPasswordNoteId);
                if (note) {
                    note.password = null;
                    saveNotes();
                    renderNotes(document.getElementById('searchInput').value);
                }
                closePasswordPopup();
            }
        }

        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editorText').focus();
        }

        function insertChecklist() {
            document.execCommand('insertHTML', false, '<input type="checkbox"> <span contenteditable="true"></span><br>');
            document.getElementById('editorText').focus();
        }

        function toggleDragAndDrop() {
            dragAndDropEnabled = !dragAndDropEnabled;
            renderNotes(document.getElementById('searchInput').value);
            alert(dragAndDropEnabled ? 'Drag & Drop enabled' : 'Drag & Drop disabled');
        }

        function toggleOfflineMode() {
            offlineModeEnabled = !offlineModeEnabled;
            if (offlineModeEnabled && 'serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript;base64,' + btoa('self.addEventListener("fetch", e => e.respondWith(fetch(e.request)));'));
            }
            alert(offlineModeEnabled ? 'Offline Mode enabled' : 'Offline Mode disabled');
        }

        function toggleChecklist() {
            checklistEnabled = !checklistEnabled;
            document.getElementById('checklistBtn').style.display = checklistEnabled ? 'inline-block' : 'none';
            alert(checklistEnabled ? 'Checklist enabled' : 'Checklist disabled');
        }

        function toggleTextFormatting() {
            textFormattingEnabled = !textFormattingEnabled;
            document.getElementById('formattingToolbar').style.display = textFormattingEnabled ? 'flex' : 'none';
            alert(textFormattingEnabled ? 'Text Formatting enabled' : 'Text Formatting disabled');
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (note) {
                if (note.password) {
                    const pass = prompt('Enter password to edit:');
                    if (pass !== note.password) {
                        alert('Incorrect password');
                        return;
                    }
                }
                document.getElementById('editorTitle').value = note.title;
                document.getElementById('editorText').innerHTML = note.content;
                const [date, time] = note.reminderTime ? note.reminderTime.split('T') : ['', ''];
                document.getElementById('reminderDate').value = date;
                document.getElementById('reminderTime').value = time;
                currentEditingId = id;
                hideTopBars();
                document.getElementById('overlay').classList.add('open');
                document.getElementById('editorPopup').style.display = 'flex';
            }
        }

        function createNewNote() {
            document.getElementById('editorTitle').value = '';
            document.getElementById('editorText').innerHTML = '';
            document.getElementById('reminderDate').value = '';
            document.getElementById('reminderTime').value = '';
            currentEditingId = null;
            hideTopBars();
            document.getElementById('overlay').classList.add('open');
            document.getElementById('editorPopup').style.display = 'flex';
        }

        function saveNote() {
            const title = document.getElementById('editorTitle').value.trim();
            const content = document.getElementById('editorText').innerHTML;
            const reminderDate = document.getElementById('reminderDate').value;
            const reminderTime = document.getElementById('reminderTime').value;
            if (!title) {
                alert('Please enter a title.');
                return;
            }
            if (currentEditingId) {
                const note = notes.find(n => n.id === currentEditingId);
                if (note) {
                    note.title = title;
                    note.content = content;
                    if (reminderDate && reminderTime) {
                        note.reminderTime = reminderDate + 'T' + reminderTime;
                        clearReminder(currentEditingId);
                        setReminder(currentEditingId, note.reminderTime);
                    } else {
                        note.reminderTime = null;
                        clearReminder(currentEditingId);
                    }
                }
            } else {
                const newNote = {
                    id: Date.now().toString(),
                    title,
                    content,
                    notification: false,
                    pinned: false,
                    reminderTime: (reminderDate && reminderTime) ? reminderDate + 'T' + reminderTime : null,
                    password: null
                };
                if (newNote.reminderTime) {
                    setReminder(newNote.id, newNote.reminderTime);
                }
                notes.unshift(newNote);
            }
            saveNotes();
            renderNotes(document.getElementById('searchInput').value);
            closeEditor();
        }

        function deleteNote(event, id) {
            event.stopPropagation();
            const noteIndex = notes.findIndex(n => n.id === id);
            if (noteIndex !== -1) {
                const note = notes[noteIndex];
                stopNoteNotifications(id);
                clearReminder(id);
                deletedNotes.unshift(notes.splice(noteIndex, 1)[0]);
                saveNotes();
                saveDeletedNotes();
                renderNotes(document.getElementById('searchInput').value);
            }
        }

        function restoreNote(id) {
            const delIndex = deletedNotes.findIndex(n => n.id === id);
            if (delIndex !== -1) {
                const note = deletedNotes[delIndex];
                notes.unshift(deletedNotes.splice(delIndex, 1)[0]);
                if (note.notification) {
                    startNoteNotifications(id);
                }
                if (note.reminderTime) {
                    setReminder(id, note.reminderTime);
                }
                saveNotes();
                saveDeletedNotes();
                renderTrash();
            }
        }

        function permanentDelete(id) {
            const delIndex = deletedNotes.findIndex(n => n.id === id);
            if (delIndex !== -1) {
                stopNoteNotifications(id);
                clearReminder(id);
                deletedNotes.splice(delIndex, 1);
                saveDeletedNotes();
                renderTrash();
            }
        }

        function closeEditor() {
            document.getElementById('editorPopup').style.display = 'none';
            document.getElementById('overlay').classList.remove('open');
            currentEditingId = null;
            showTopBars();
        }

        function saveNotes() {
            localStorage.setItem('notes', JSON.stringify(notes));
        }

        function saveDeletedNotes() {
            localStorage.setItem('deletedNotes', JSON.stringify(deletedNotes));
        }

        function goHome() {
            renderNotes();
            closeEditor();
            closeLeftSidebar();
            closeRightSidebar();
            document.getElementById('invitePopup').style.display = 'none';
            showTopBars();
        }

        function openInvite() {
            hideTopBars();
            document.getElementById('overlay').classList.add('open');
            document.getElementById('invitePopup').style.display = 'flex';
        }

        function toggleLeftSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const overlay = document.getElementById('overlay');

            if (sidebar.classList.contains('open')) {
                closeLeftSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('open');
                hideTopBars();
                renderTrash();
            }
        }

        function closeLeftSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            showTopBars();
        }

        function toggleRightSidebar() {
            const sidebar = document.getElementById('rightSidebar');
            const overlay = document.getElementById('overlay');

            if (sidebar.classList.contains('open')) {
                closeRightSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('open');
                hideTopBars();
            }
        }

        function closeRightSidebar() {
            const sidebar = document.getElementById('rightSidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            showTopBars();
        }

        function closeSidebars() {
            closeLeftSidebar();
            closeRightSidebar();
        }

        function handleSettingsItem(type) {
            if (type === 'about') {
                showAboutPopup();
            } else if (type === 'clear') {
                showClearDataPopup();
            }
        }

        function showAboutPopup() {
            hideTopBars();
            document.getElementById('overlay').classList.add('open');
            document.getElementById('aboutPopup').style.display = 'flex';
        }

        function closeAbout() {
            document.getElementById('aboutPopup').style.display = 'none';
            document.getElementById('overlay').classList.remove('open');
            showTopBars();
        }

        function showClearDataPopup() {
            hideTopBars();
            document.getElementById('overlay').classList.add('open');
            document.getElementById('clearDataPopup').style.display = 'flex';
        }

        // Drag and Drop
        if (dragAndDropEnabled) {
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('note-file')) {
                    draggedNoteId = e.target.dataset.id;
                    e.target.style.opacity = '0.5';
                }
            });

            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('note-file')) {
                    e.target.style.opacity = '1';
                }
            });

            document.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            document.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedNoteId && e.target.closest('.main-content')) {
                    const dropY = e.clientY;
                    const allNotes = [...document.querySelectorAll('.note-file')];
                    const afterElement = allNotes.reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = dropY - box.top - box.height / 2;
                        if (offset < 0 && offset > closest.offset) {
                            return { offset: offset, element: child };
                        } else {
                            return closest;
                        }
                    }, { offset: Number.NEGATIVE_INFINITY }).element;

                    const draggedNote = notes.find(n => n.id === draggedNoteId);
                    const draggedIndex = notes.indexOf(draggedNote);
                    notes.splice(draggedIndex, 1);
                    const dropIndex = afterElement ? notes.indexOf(notes.find(n => n.id === afterElement.dataset.id)) : notes.length;
                    notes.splice(dropIndex, 0, draggedNote);
                    saveNotes();
                    renderNotes(document.getElementById('searchInput').value);
                }
                draggedNoteId = null;
            });
        }

        // Event listeners
        document.getElementById('menuIcon').addEventListener('click', toggleLeftSidebar);
        document.getElementById('copyBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        });

        // Share icons
        document.querySelectorAll('.share-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                const alt = icon.alt;
                let shareUrl = '';
                let text = '';
                if (alt === 'X') {
                    text = shortText;
                    shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                } else if (alt === 'Facebook') {
                    text = longText;
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text.replace(url, ''))}`;
                } else if (alt === 'WhatsApp') {
                    text = longText;
                    shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
                } else if (alt === 'Telegram') {
                    text = longText;
                    shareUrl = `https://t.me/share/url?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
                } else if (alt === 'Share') {
                    if (navigator.share) {
                        navigator.share({title: 'JokeFi Notes', text: longText});
                    } else {
                        alert('Share this link: ' + url);
                    }
                    return;
                }
                window.open(shareUrl, '_blank');
            });
        });

        // Clear Data buttons
        document.getElementById('confirmClear').addEventListener('click', () => {
            // Clear intervals
            Object.keys(notificationIntervals).forEach(id => clearInterval(notificationIntervals[id]));
            notificationIntervals = {};
            Object.keys(reminderTimeouts).forEach(id => clearTimeout(reminderTimeouts[id]));
            reminderTimeouts = {};
            notes = [];
            deletedNotes = [];
            saveNotes();
            saveDeletedNotes();
            renderNotes();
            document.getElementById('clearDataPopup').style.display = 'none';
            document.getElementById('overlay').classList.remove('open');
            showTopBars();
        });

        document.getElementById('cancelClear').addEventListener('click', () => {
            document.getElementById('clearDataPopup').style.display = 'none';
            document.getElementById('overlay').classList.remove('open');
            showTopBars();
        });

        // Close popups on outside click
        document.querySelectorAll('.popup').forEach(popup => {
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.style.display = 'none';
                    document.getElementById('overlay').classList.remove('open');
                    showTopBars();
                }
            });
        });

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderNotes(e.target.value);
        });

        // Initial render and restore notifications
        renderNotes();
        notes.forEach(note => {
            if (note.notification) {
                startNoteNotifications(note.id);
            }
            if (note.reminderTime) {
                setReminder(note.id, note.reminderTime);
            }
        });
    </script>
</body>
</html>
